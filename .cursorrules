# SISTEMA SGMM - REGLAS DE DESARROLLO
# Sistema de Gesti√≥n de Gastos M√©dicos Mayores
# Arquitectura: Clean Architecture con Hexagonal Design

## üéØ OBJETIVO PRINCIPAL
Implementar un sistema SGMM funcional, escalable y mantenible siguiendo arquitectura limpia y principios SOLID.

## üìã REGLAS DE DESARROLLO OBLIGATORIAS

### 1. METODOLOG√çA DE BLOQUES DE TRABAJO
- **BLOQUES AT√ìMICOS**: Unidades de trabajo completas de 30-90 minutos
- **VALIDACI√ìN POR BLOQUE**: Validaci√≥n r√°pida al finalizar cada bloque (5-10 min)
- **CERO DEUDA T√âCNICA**: Resolver problemas cr√≠ticos inmediatamente
- **DOCUMENTACI√ìN INLINE**: Comentarios en c√≥digo + actualizaci√≥n de README
- **COMMITS SIGNIFICATIVOS**: Un commit por bloque con mensaje descriptivo
- **CHECKPOINT**: Verificar que funciona antes de continuar al siguiente bloque

**Referencia**: Ver documentaci√≥n de fases en `/docs/FASE_*.md` para detalles completos

### 2. CRITERIOS DE VALIDACI√ìN POR TAREA OBLIGATORIOS
- **ANALIZAR IMPACTO COMPLETO**: ¬øQu√© se ve afectado por este cambio?
- **MAPEAR DEPENDENCIAS**: ¬øQu√© depende de esto y de qu√© depende esto?
- **VERIFICAR IMPORTS**: ¬øEst√°n correctos todos los imports necesarios?
- **COMPRENDER ECOSISTEMA**: ¬øC√≥mo se integra esto con el resto del sistema?
- **VALIDAR CON GATES**: Ejecutar validaciones antes de aceptar cambios
- **AN√ÅLISIS FORENSE**: Investigar causa ra√≠z antes de implementar soluciones

### 3. DOCUMENTACI√ìN COMO FUENTE DE VERDAD
- **CONSULTAR SIEMPRE**: `/docs` antes de implementar cualquier funcionalidad
- **DICCIONARIO DE DATOS**: `/docs/DATA_DICTIONARY.md` - **CONSULTA OBLIGATORIA** antes de queries Prisma
- **CONVENCIONES DE NOMENCLATURA**: `/docs/NAMING_CONVENTIONS.md` - Gu√≠a detallada
- **PLANES DE FASES**: `/docs/FASE_*.md` - **CONSULTA OBLIGATORIA** para implementaci√≥n
- **DICCIONARIO = LEY**: Si hay conflicto entre c√≥digo y diccionario, el diccionario tiene raz√≥n
- **ACTUALIZAR AL CERRAR**: Documentar cuando se completa un m√≥dulo/funcionalidad
- **NO INVENTAR**: Usar la documentaci√≥n existente como base
- **VALIDAR CONSISTENCIA**: Asegurar que documentaci√≥n y c√≥digo est√©n alineados

### 4. ARQUITECTURA Y PRINCIPIOS
- **CLEAN ARCHITECTURE**: Seguir capas bien definidas (Domain, Application, Infrastructure)
- **SOLID PRINCIPLES**: Aplicar los 5 principios en todo el c√≥digo
- **HEXAGONAL DESIGN**: Desacoplar la l√≥gica de negocio de la infraestructura
- **DEPENDENCY INJECTION**: Usar inyecci√≥n de dependencias para desacoplamiento
- **INTERFACE SEGREGATION**: Crear interfaces espec√≠ficas y cohesivas
- **SINGLE RESPONSIBILITY**: Una clase = una responsabilidad
- **NO GOD CLASSES**: Evitar clases que hagan demasiado

### 2. DOCUMENTACI√ìN COMO FUENTE DE VERDAD
- **CONSULTAR SIEMPRE**: `/docs` antes de implementar cualquier funcionalidad
- **DICCIONARIO DE DATOS**: `/docs/DATA_DICTIONARY.md` - **CONSULTA OBLIGATORIA** antes de queries
- **ESQUEMA DE BD**: `/docs/DATABASE_SCHEMA_COMPLETE.md` - **CONSULTA OBLIGATORIA** para estructura
- **HISTORIAS DE USUARIO**: Validar funcionalidades contra requirements
- **DICCIONARIO = LEY**: Si hay conflicto entre c√≥digo y diccionario, el diccionario tiene raz√≥n
- **ACTUALIZAR DOCUMENTACI√ìN**: Mantener docs sincronizadas con c√≥digo

### 3. CONVENCIONES DE NOMENCLATURA

#### **Backend (Node.js + TypeScript)**
- **Archivos**: `kebab-case` (user-service.ts, employee-repository.ts)
- **Clases**: `PascalCase` (UserService, EmployeeRepository)
- **Interfaces**: `PascalCase` con prefijo `I` (IUserService, IEmployeeRepository)
- **Funciones**: `camelCase` (getUserById, createEmployee)
- **Constantes**: `UPPER_SNAKE_CASE` (MAX_FILE_SIZE, DEFAULT_TIMEOUT)
- **Variables**: `camelCase` (userEmail, employeeData)
- **Enums**: `PascalCase` (UserRole, EmployeeStatus)

#### **Frontend (React + TypeScript)**
- **Componentes**: `PascalCase` (UserProfile, EmployeeList)
- **Hooks**: `camelCase` con prefijo `use` (useAuth, useEmployeeData)
- **Archivos**: `kebab-case` (user-profile.tsx, employee-list.tsx)
- **Props**: `camelCase` (userId, employeeData)
- **Estados**: `camelCase` (isLoading, userData)

#### **Base de Datos**
- **Tablas**: `snake_case` en plural (employees, dependents)
- **Campos**: `snake_case` (employee_id, created_at)
- **√çndices**: `idx_tabla_campo` (idx_employees_email)
- **Foreign Keys**: `fk_tabla_campo` (fk_dependents_employee_id)

### 4. ESTRUCTURA DE PROYECTO

#### **Backend Structure**
```
backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/           # Configuraciones
‚îÇ   ‚îú‚îÄ‚îÄ modules/          # M√≥dulos de negocio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ employees/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain/   # Entidades, interfaces, tipos
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ application/ # Casos de uso, servicios
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ infrastructure/ # Repositorios, adapters
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dependents/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ reports/
‚îÇ   ‚îú‚îÄ‚îÄ shared/           # Utilidades compartidas
‚îÇ   ‚îî‚îÄ‚îÄ server.ts         # Punto de entrada
‚îú‚îÄ‚îÄ prisma/               # Esquema y migraciones
‚îî‚îÄ‚îÄ docs/                 # Documentaci√≥n t√©cnica
```

#### **Frontend Structure**
```
frontend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ components/       # Componentes reutilizables
‚îÇ   ‚îú‚îÄ‚îÄ pages/           # P√°ginas de la aplicaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ hooks/           # Custom hooks
‚îÇ   ‚îú‚îÄ‚îÄ services/        # Servicios de API
‚îÇ   ‚îú‚îÄ‚îÄ types/           # Tipos TypeScript
‚îÇ   ‚îú‚îÄ‚îÄ utils/           # Utilidades
‚îÇ   ‚îî‚îÄ‚îÄ styles/          # Estilos globales
‚îî‚îÄ‚îÄ docs/                # Documentaci√≥n frontend
```

### 5. REGLAS DE C√ìDIGO

#### **TypeScript**
- **STRICT MODE**: Siempre habilitado
- **NO ANY**: Evitar tipo `any`, usar tipos espec√≠ficos
- **INTERFACES**: Preferir interfaces sobre types para objetos
- **ENUMS**: Usar enums para valores constantes
- **NULL SAFETY**: Manejar null/undefined expl√≠citamente
- **ASYNC/AWAIT**: Preferir sobre Promises.then()

#### **Error Handling**
- **TRY-CATCH**: En todas las operaciones as√≠ncronas
- **CUSTOM ERRORS**: Crear errores espec√≠ficos del dominio
- **LOGGING**: Registrar errores con contexto suficiente
- **USER-FRIENDLY**: Mostrar mensajes de error claros al usuario

#### **Testing**
- **UNIT TESTS**: Para l√≥gica de negocio
- **INTEGRATION TESTS**: Para APIs y servicios
- **MOCKING**: Mockear dependencias externas
- **COVERAGE**: Mantener cobertura > 80%

### 6. REGLAS DE BASE DE DATOS

#### **Prisma ORM**
- **SCHEMA FIRST**: Definir esquema antes de c√≥digo
- **MIGRATIONS**: Usar migraciones para cambios de BD
- **VALIDATIONS**: Validaciones en esquema Prisma
- **RELATIONS**: Definir relaciones expl√≠citas
- **INDEXES**: Crear √≠ndices para campos de b√∫squeda

#### **Queries**
- **PARAMETERIZED**: Usar par√°metros, nunca concatenaci√≥n
- **LIMITS**: Limitar resultados de consultas grandes
- **PAGINATION**: Para listas grandes
- **OPTIMIZATION**: Revisar performance de queries complejas

### 7. REGLAS DE SEGURIDAD

#### **Autenticaci√≥n**
- **SAML**: Usar SAML con Google Workspace
- **JWT**: Para sesiones despu√©s de SAML
- **COOKIES**: HttpOnly, Secure, SameSite
- **TIMEOUT**: Sesiones con expiraci√≥n autom√°tica

#### **Autorizaci√≥n**
- **ROLE-BASED**: Sistema de roles (EMPLOYEE, HR_ADMIN, SUPER_ADMIN)
- **RESOURCE-BASED**: Empleados solo ven sus propios datos
- **MIDDLEWARE**: Validar permisos en cada endpoint

#### **Datos Sensibles**
- **ENCRYPTION**: Datos sensibles encriptados
- **AUDIT TRAIL**: Registrar todas las acciones
- **PRIVACY**: Aceptaci√≥n de aviso de privacidad obligatoria
- **SOFT DELETE**: Nunca eliminaci√≥n f√≠sica

### 8. REGLAS DE ARCHIVOS Y DOCUMENTOS

#### **Google Drive Integration**
- **STRUCTURE**: Organizar por empleado/dependiente
- **NAMING**: Usar ID compuesto (3619-a01)
- **VALIDATION**: Validar tama√±o y tipo de archivo
- **SECURITY**: Control de acceso por roles

#### **File Upload**
- **MAX SIZE**: 5MB por archivo
- **ALLOWED TYPES**: PDF, JPG, JPEG, PNG
- **FIRST TIME**: Upload obligatorio para dependientes nuevos
- **METADATA**: Guardar informaci√≥n de upload

### 9. REGLAS DE REPORTES

#### **Generaci√≥n**
- **ON-DEMAND**: Generar din√°micamente, no almacenar
- **VIEWS**: Usar vistas SQL para reportes complejos
- **FORMATS**: Excel, PDF, CSV
- **FILTERING**: Por compa√±√≠a, fecha, estado

#### **Tipos de Reporte**
- **INSURER**: Para aseguradora con todos los dependientes
- **PAYROLL_DEDUCTIONS**: Para n√≥minas con dependientes extra
- **AUDIT**: Trail de auditor√≠a para RH

### 10. REGLAS DE PERFORMANCE

#### **Backend**
- **CACHING**: Cache para datos frecuentemente accedidos
- **PAGINATION**: Para listas grandes
- **LAZY LOADING**: Cargar datos bajo demanda
- **INDEXING**: √çndices en campos de b√∫squeda

#### **Frontend**
- **CODE SPLITTING**: Dividir c√≥digo por rutas
- **LAZY LOADING**: Cargar componentes bajo demanda
- **OPTIMIZATION**: Optimizar im√°genes y assets
- **BUNDLING**: Usar bundling eficiente

### 11. REGLAS DE DEPLOYMENT

#### **Docker**
- **MULTI-STAGE**: Builds optimizados
- **SECRETS**: Variables de entorno para secretos
- **HEALTH CHECKS**: Verificar salud de contenedores
- **LOGGING**: Configurar logging centralizado

#### **Environment**
- **SEPARATION**: Dev, Staging, Production
- **CONFIG**: Variables de entorno para configuraci√≥n
- **SECRETS**: Nunca hardcodear secretos
- **BACKUPS**: Backup autom√°tico de BD

### 12. REGLAS DE COMMITS Y VERSIONADO

#### **Git Commits**
- **CONVENTIONAL**: Usar Conventional Commits
- **ATOMIC**: Un commit = una funcionalidad
- **DESCRIPTIVE**: Mensajes claros y descriptivos
- **SIGNED**: Firmar commits cuando sea posible

#### **Versionado**
- **SEMANTIC**: Semantic Versioning (MAJOR.MINOR.PATCH)
- **CHANGELOG**: Mantener changelog actualizado
- **TAGS**: Tag releases importantes

### 13. REGLAS DE MONITOREO Y LOGGING

#### **Logging**
- **STRUCTURED**: JSON logs para parsing
- **LEVELS**: DEBUG, INFO, WARN, ERROR
- **CONTEXT**: Incluir contexto suficiente
- **CORRELATION**: IDs de correlaci√≥n para traces

#### **Monitoring**
- **METRICS**: M√©tricas de performance y uso
- **ALERTS**: Alertas para errores cr√≠ticos
- **DASHBOARDS**: Dashboards para monitoreo
- **HEALTH**: Health checks autom√°ticos

### 14. REGLAS DE DOCUMENTACI√ìN

#### **Code Documentation**
- **JSDoc**: Documentar funciones p√∫blicas
- **README**: README actualizado por m√≥dulo
- **API DOCS**: Documentaci√≥n de APIs
- **ARCHITECTURE**: Documentar decisiones arquitect√≥nicas

#### **User Documentation**
- **USER STORIES**: Historias de usuario claras
- **REQUIREMENTS**: RF y RNF documentados
- **MANUALS**: Manuales de usuario
- **FAQ**: Preguntas frecuentes

### 15. REGLAS DE CALIDAD

#### **Code Quality**
- **LINTING**: ESLint, Prettier configurados
- **FORMATTING**: Formato consistente
- **COMPLEXITY**: Evitar complejidad ciclom√°tica alta
- **DUPLICATION**: Evitar c√≥digo duplicado

#### **Reviews**
- **PULL REQUESTS**: Review obligatorio
- **CHECKLIST**: Checklist de review
- **TESTING**: Verificar que tests pasen
- **DOCUMENTATION**: Verificar documentaci√≥n actualizada

---

## üö® VALIDACIONES OBLIGATORIAS ANTES DE COMMIT

### **Backend**
- [ ] Tests unitarios pasan
- [ ] Tests de integraci√≥n pasan
- [ ] Linting sin errores
- [ ] Tipos TypeScript correctos
- [ ] Documentaci√≥n actualizada
- [ ] Schema Prisma validado
- [ ] Migraciones aplicadas

### **Frontend**
- [ ] Componentes renderizan correctamente
- [ ] Tests unitarios pasan
- [ ] Linting sin errores
- [ ] Tipos TypeScript correctos
- [ ] Responsive design verificado
- [ ] Accesibilidad b√°sica verificada

### **General**
- [ ] Funcionalidad probada manualmente
- [ ] Performance aceptable
- [ ] Seguridad verificada
- [ ] Documentaci√≥n actualizada
- [ ] Commits at√≥micos y descriptivos

---

## üìã CHECKLIST DE AN√ÅLISIS ANTES DE CAMBIOS

### **Impacto**
- [ ] ¬øQu√© m√≥dulos se ven afectados?
- [ ] ¬øQu√© dependencias externas hay?
- [ ] ¬øQu√© APIs cambian?
- [ ] ¬øQu√© base de datos se modifica?

### **Arquitectura**
- [ ] ¬øSigue principios SOLID?
- [ ] ¬øMantiene clean architecture?
- [ ] ¬øNo viola separaci√≥n de capas?
- [ ] ¬øEs testable?

### **Seguridad**
- [ ] ¬øSe validan inputs?
- [ ] ¬øSe manejan errores correctamente?
- [ ] ¬øSe registra en audit trail?
- [ ] ¬øSe respetan permisos?

### **Performance**
- [ ] ¬øSe optimizan queries?
- [ ] ¬øSe usa caching cuando corresponde?
- [ ] ¬øSe evitan N+1 queries?
- [ ] ¬øSe limitan resultados?

---

## üéØ OBJETIVOS DE CALIDAD

- **Cobertura de tests**: > 80%
- **Performance**: < 2s respuesta API
- **Disponibilidad**: 99.9%
- **Seguridad**: 0 vulnerabilidades cr√≠ticas
- **Mantenibilidad**: Complejidad ciclom√°tica < 10
- **Documentaci√≥n**: 100% de APIs documentadas

---

*√öltima actualizaci√≥n: 2025-01-15*
*Versi√≥n: 1.0*
*Responsable: Equipo de Desarrollo SGMM*